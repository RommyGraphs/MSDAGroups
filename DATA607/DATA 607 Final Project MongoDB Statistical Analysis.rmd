---
title: "DATA 607 Final Project - MongoDB Statistical Analysis - Global Perspective"
author: "Jason Givens-Doyle, Romerl Elizes & Soumya Ghosh"
date: "December 12, 2018"
output: 
  html_document: 
    toc: true
    df_print: kable
    theme: cerulean
    highlight: pygments
    css: ./lab.css
  #  code_folding:hide
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message=FALSE, warning=FALSE}
library(RODBC)
library(mongolite)
library(knitr)
library(psych)
library(kableExtra)
library(stringr)
library(dplyr)
library(tidyr)
library(scales)
library(ggplot2)
library(plotly)
library(maps)
library(mapdata)
library(ggrepel) #not using this at the moment, but it does give the option to add labels.  While not useful for the 

options(knitr.table.format = "html")
```


```{r connect-to-mongodatabase, eval=TRUE}
mbreast <- mongo("breast")
mdigothr <- mongo("digothr")
mmalegen <- mongo("malegen")
mfemgen <- mongo("femgent")
mother <- mongo("other")
mrespir <- mongo("respir")
mcolrect <- mongo("colrect")
mlymyleuk <- mongo("lymyleuk")
murinary <- mongo("urinary")

```

```{r store-data-into-data-frames, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
breastDF <- mbreast$find(
  query = '{"birthYear" : { "$gt" : 1979 }, "ageDiagnosis" : { "$gt" : 19 }, "survivalMonths" : { "$lt" : 9999 } }', 
  fields = '{ "ageDiagnosis" : true, "yearDiagnosis" : true, "survivalMonths" : true, "_id" : false }')
digothrDF <- mdigothr$find(
  query = '{"birthYear" : { "$gt" : 1979 }, "ageDiagnosis" : { "$gt" : 19 }, "survivalMonths" : { "$lt" : 9999 } }', 
  fields = '{ "ageDiagnosis" : true, "yearDiagnosis" : true, "survivalMonths" : true, "_id" : false }')
malegenDF <- mmalegen$find(
  query = '{"birthYear" : { "$gt" : 1979 }, "ageDiagnosis" : { "$gt" : 19 }, "survivalMonths" : { "$lt" : 9999 } }', 
  fields = '{ "ageDiagnosis" : true, "yearDiagnosis" : true, "survivalMonths" : true, "_id" : false }')
femgenDF <- mfemgen$find(
  query = '{"birthYear" : { "$gt" : 1979 }, "ageDiagnosis" : { "$gt" : 19 }, "survivalMonths" : { "$lt" : 9999 } }', 
  fields = '{ "ageDiagnosis" : true, "yearDiagnosis" : true, "survivalMonths" : true, "_id" : false }')
otherDF <- mother$find(
  query = '{"birthYear" : { "$gt" : 1979 }, "ageDiagnosis" : { "$gt" : 19 }, "survivalMonths" : { "$lt" : 9999 } }', 
  fields = '{ "ageDiagnosis" : true, "yearDiagnosis" : true, "survivalMonths" : true, "_id" : false }')
respirDF <- mrespir$find(
  query = '{"birthYear" : { "$gt" : 1979 }, "ageDiagnosis" : { "$gt" : 19 }, "survivalMonths" : { "$lt" : 9999 } }', 
  fields = '{ "ageDiagnosis" : true, "yearDiagnosis" : true, "survivalMonths" : true, "_id" : false }')
colrectDF <- mcolrect$find(
  query = '{"birthYear" : { "$gt" : 1979 }, "ageDiagnosis" : { "$gt" : 19 }, "survivalMonths" : { "$lt" : 9999 } }', 
  fields = '{ "ageDiagnosis" : true, "yearDiagnosis" : true, "survivalMonths" : true, "_id" : false }')
lymyleukDF <- mlymyleuk$find(
  query = '{"birthYear" : { "$gt" : 1979 }, "ageDiagnosis" : { "$gt" : 19 }, "survivalMonths" : { "$lt" : 9999 } }', 
  fields = '{ "ageDiagnosis" : true, "yearDiagnosis" : true, "survivalMonths" : true, "_id" : false }')
urinaryDF <- murinary$find(
  query = '{"birthYear" : { "$gt" : 1979 }, "ageDiagnosis" : { "$gt" : 19 }, "survivalMonths" : { "$lt" : 9999 } }', 
  fields = '{ "ageDiagnosis" : true, "yearDiagnosis" : true, "survivalMonths" : true, "_id" : false }')

breastDF <- na.omit(breastDF)
digothrDF <- na.omit(digothrDF)
malegenDF <- na.omit(malegenDF)
femgenDF <- na.omit(femgenDF)
otherDF <- na.omit(otherDF)
respirDF <- na.omit(respirDF)
colrectDF <- na.omit(colrectDF)
lymyleukDF <- na.omit(lymyleukDF)
urinaryDF <- na.omit(urinaryDF)

nrow(breastDF)
nrow(digothrDF)
nrow(malegenDF)
nrow(femgenDF)
nrow(otherDF)
nrow(respirDF)
nrow(colrectDF)
nrow(lymyleukDF)
nrow(urinaryDF)

breastDF <- mutate(breastDF,survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis)
digothrDF <- mutate(digothrDF,survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis)
malegenDF <- mutate(malegenDF,survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis)
femgenDF <- mutate(femgenDF,survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis)
otherDF <- mutate(otherDF,survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis)
respirDF <- mutate(respirDF,survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis)
colrectDF <- mutate(colrectDF,survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis)
lymyleukDF <- mutate(lymyleukDF,survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis)
urinaryDF <- mutate(urinaryDF,survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis)

breastDF <- breastDF[ which(breastDF$currentYear < 2016), ]
digothrDF <- digothrDF[ which(digothrDF$currentYear < 2016), ]
malegenDF <- malegenDF[ which(malegenDF$currentYear < 2016), ]
femgenDF <- femgenDF[ which(femgenDF$currentYear < 2016), ]
otherDF <- otherDF[ which(otherDF$currentYear < 2016), ]
respirDF <- respirDF[ which(respirDF$currentYear < 2016), ]
colrectDF <- colrectDF[ which(colrectDF$currentYear < 2016), ]
lymyleukDF <- lymyleukDF[ which(lymyleukDF$currentYear < 2016), ]
urinaryDF <- urinaryDF[ which(urinaryDF$currentYear < 2016), ]

```

```{r project_functions, display=TRUE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
plot_ss <- function(x, y, maintitle, showSquares = FALSE, leastSquares = FALSE){
  plot(x,y,xlab="Diagnosis Year", ylab = "Survival Years", main = maintitle)

  if(leastSquares){
    m1 <- lm(y~x)
    y.hat <- m1$fit
  } else{
    pt1 <- locator(1)
    points(pt1$x, pt1$y, pch = 4)
    pt2 <- locator(1)
    points(pt2$x, pt2$y, pch = 4)
    pts <- data.frame("x" = c(pt1$x, pt2$x),"y" = c(pt1$y, pt2$y))
    m1 <- lm(y ~ x, data = pts)
    y.hat <- predict(m1, newdata = data.frame(x))
  }
  r <- y - y.hat
  abline(m1)

  oSide <- x - r
  LLim <- par()$usr[1]
  RLim <- par()$usr[2]
  oSide[oSide < LLim | oSide > RLim] <- c(x + r)[oSide < LLim | oSide > RLim] # move boxes to avoid margins

  n <- length(y.hat)
  for(i in 1:n){
    lines(rep(x[i], 2), c(y[i], y.hat[i]), lty = 2, col = "blue")
    if(showSquares){
    lines(rep(oSide[i], 2), c(y[i], y.hat[i]), lty = 3, col = "orange")
    lines(c(oSide[i], x[i]), rep(y.hat[i],2), lty = 3, col = "orange")
    lines(c(oSide[i], x[i]), rep(y[i],2), lty = 3, col = "orange")
    }
  }

}

summaryTable <- function(cancerType,maintitle = ""){
  survivalYears = cancerType$survivalYears
  yearDiagnosis = cancerType$yearDiagnosis
  meanTable <- tapply(survivalYears,yearDiagnosis,mean)
  show(nrow(cancerType))
  show(describeBy(survivalYears, group = yearDiagnosis, mat=TRUE))
  barplot(meanTable,beside=T,col=c("#ee7700","#3333ff")
    ,main=maintitle,xlab="Diagnosis Year",ylab="Survival Years")
}


inferenceTests <- function(cancerType, maintitle = "") {
  yearDiagnosis <- cancerType$yearDiagnosis
  survivalYears <- cancerType$survivalYears
  plot_ss(x = yearDiagnosis, y = survivalYears, maintitle, showSquares = FALSE)
  m2 <- lm(survivalYears ~ yearDiagnosis, data = cancerType)
  summary(m2)
}

inferenceTest0 <- function(cancerType) {
  m2 <- lm(survivalYears ~ yearDiagnosis, data = cancerType)
  hist(m2$residuals)
  qqnorm(m2$residuals)
  qqline(m2$residuals)  
}
```

```{r breast-Statistics,echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(breastDF,"Breast Cancer - Diagnosis Year vs. Average Survival Years")
```

```{r digothr-Statistics,echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(digothrDF,"Digestive Cancer - Diagnosis Year vs. Average Survival Years")
```

```{r malegen-Statistics,echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(malegenDF,"Male Genital Cancer - Diagnosis Year vs. Average Survival Years")
```

```{r femgen-Statistics,echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(femgenDF,"Female Genital Cancer - Diagnosis Year vs. Average Survival Years")
```

```{r respir-Statistics,echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(respirDF,"Respiratory Cancer - Diagnosis Year vs. Average Survival Years")
```

```{r colrect-Statistics,echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(colrectDF,"Colon/Rectum Cancer - Diagnosis Year vs. Average Survival Years")
```

```{r lymyleuk-Statistics,echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(lymyleukDF,"Lymphoma/Leukemia Cancer - Diagnosis Year vs. Average Survival Years")
```

```{r urinary-Statistics,echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(urinaryDF,"Urinary Cancer - Diagnosis Year vs. Average Survival Years")
```

```{r other-Statistics,echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(otherDF,"Other Cancers - Diagnosis Year vs. Average Survival Years")
```

```{r BreastCancer-InferenceTest, echo=TRUE}
inferenceTests(breastDF, "Breast Cancer - Inference Analysis")
```

**H~0~:** There is no evidence that Breast Cancer Survival Years are improving as Diagnosis Year increases.

**H~1~:** There is sufficient evidence that Breast Cancer Survival Years are improving as Diagnosis Year increases.

```{r DigestiveCancer-InferenceTest, echo=TRUE}
inferenceTests(digothrDF, "Digestive Cancer - Inference Analysis")
```

**H~0~:** There is no evidence that Digestive Cancer Survival Years are improving as Diagnosis Year increases.

**H~1~:** There is sufficient evidence that Digestive Cancer Survival Years are improving as Diagnosis Year increases.

```{r Male Genital Cancer-InferenceTest, echo=TRUE}
inferenceTests(malegenDF, "Male Genital Cancer - Inference Analysis")
```

**H~0~:** There is no evidence that Male Genital Cancer Survival Years are improving as Diagnosis Year increases.

**H~1~:** There is sufficient evidence that Male Genital Cancer Survival Years are improving as Diagnosis Year increases.

```{r Female Genital Cancer-InferenceTest, echo=TRUE}
inferenceTests(femgenDF, "Female Genital Cancer - Inference Analysis")
```

**H~0~:** There is no evidence that Female Genital Cancer Survival Years are improving as Diagnosis Year increases.

**H~1~:** There is sufficient evidence that Female Genital Cancer Survival Years are improving as Diagnosis Year increases.